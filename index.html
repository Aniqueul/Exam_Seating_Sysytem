<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Exam Seating System</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">Exam Seating</div>
      <ul>
        <li class="active"><a href="index.html">Dashboard</a></li>
        <li><a href="departments.html">Departments</a></li>
        <li><a href="semesters.html">Semesters</a></li>
        <li><a href="students.html">Students</a></li>
        <li><a href="rooms.html">Rooms</a></li>
        <li><a href="seating-plans.html">Seating Plans</a></li>
        <li><a href="allocated-seats.html">Allocated Seats</a></li>
      </ul>
    </aside>

    <!-- Main -->
    <main class="main">
      <header class="topbar">
        <h1>Exam Seating Dashboard</h1>
        <div class="actions">
          <button id="themeToggle">ðŸŒ™</button>
          <button id="openModal">+ Generate Plan</button>
          <div class="user">
            <img src="https://i.pravatar.cc/40" alt="Admin" />
            <span>Admin</span>
          </div>
        </div>
      </header>

      <!-- Dashboard Cards -->
      <section class="cards">
        <div class="card">
          <h3>Departments</h3>
          <p id="departmentsCount">0</p>
        </div>
        <div class="card">
          <h3>Semesters</h3>
          <p id="semestersCount">0</p>
        </div>
        <div class="card">
          <h3>Students</h3>
          <p id="studentsCount">0</p>
        </div>
        <div class="card">
          <h3>Rooms</h3>
          <p id="roomsCount">0</p>
        </div>
        <div class="card">
          <h3>Plans</h3>
          <p id="plansCount">0</p>
        </div>
      </section>

      <!-- Seating Plans Table -->
      <section class="table-section">
        <h2>Seating Plans</h2>
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>Plan Date</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="seatingPlansBody">
            <!-- Dynamic data will populate here -->
          </tbody>
        </table>
      </section>

      <!-- Seating Plan Layout -->
      <section
        class="table-section"
        id="planLayoutSection"
        style="display: none"
      >
        <h2>Seating Plan Layout</h2>
        <div>
          <label>Choose Room: </label>
          <select id="roomFilter"></select>
          <button id="exportPDF" class="btn-primary">Export as PDF</button>
        </div>
        <table id="planLayoutTable">
          <!-- Dynamic seating layout -->
        </table>
      </section>
    </main>

    <!-- Generate Plan Modal -->
    <div class="modal" id="planModal">
      <div class="modal-content">
        <h2>Generate Seating Plan</h2>
        <form id="generatePlanForm">
          <label>Title</label>
          <input
            type="text"
            name="title"
            placeholder="Midterm Fall 2025"
            required
          />

          <label>Exam Date</label>
          <input type="date" name="plan_date" required />

          <label>Department</label>
          <select name="department_id" id="departmentSelect"></select>

          <label>Semester</label>
          <select name="semester_id" id="semesterSelect"></select>

          <div class="modal-actions">
            <button type="button" id="closeModal">Cancel</button>
            <button type="submit" class="btn-primary">Generate</button>
          </div>
        </form>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script>
      // ðŸŒ™ Theme Toggle
      const toggle = document.getElementById("themeToggle");
      toggle.addEventListener("click", () => {
        document.body.classList.toggle("dark");
      });

      // ðŸ§¾ Modal Control
      const modal = document.getElementById("planModal");
      const openBtn = document.getElementById("openModal");
      const closeBtn = document.getElementById("closeModal");

      openBtn.onclick = () => (modal.style.display = "flex");
      closeBtn.onclick = () => (modal.style.display = "none");
      window.onclick = (e) => {
        if (e.target === modal) modal.style.display = "none";
      };

      // ðŸŒ Load Dashboard & Seating Plans
      async function loadDashboardCounts() {
        try {
          const [departments, semesters, students, rooms, plans] =
            await Promise.all([
              fetch("http://localhost:5000/api/departments").then((res) =>
                res.json()
              ),
              fetch("http://localhost:5000/api/semesters").then((res) =>
                res.json()
              ),
              fetch("http://localhost:5000/api/students").then((res) =>
                res.json()
              ),
              fetch("http://localhost:5000/api/rooms").then((res) =>
                res.json()
              ),
              fetch("http://localhost:5000/api/seating-plans").then((res) =>
                res.json()
              ),
            ]);

          document.getElementById("departmentsCount").textContent =
            departments.length;
          document.getElementById("semestersCount").textContent =
            semesters.length;
          document.getElementById("studentsCount").textContent =
            students.length;
          document.getElementById("roomsCount").textContent = rooms.length;
          document.getElementById("plansCount").textContent = plans.length;

          // Populate seating plans table with clickable rows
          const seatingPlansBody = document.getElementById("seatingPlansBody");
          seatingPlansBody.innerHTML = plans
            .map(
              (plan) => `
      <tr data-plan-id="${plan.id}" style="cursor:pointer;">
        <td>${plan.title}</td>
        <td>${new Date(plan.plan_date).toLocaleDateString()}</td>
        <td class="status ${plan.status.toLowerCase()}">${plan.status}</td>
      </tr>
    `
            )
            .join("");

          // Add click to load seating layout for each plan
          document.querySelectorAll("#seatingPlansBody tr").forEach((tr) => {
            tr.onclick = () => loadAllocatedSeats(tr.dataset.planId);
          });

          // Populate modal selects
          document.getElementById("departmentSelect").innerHTML = departments
            .map((d) => `<option value="${d.id}">${d.title}</option>`)
            .join("");
          document.getElementById("semesterSelect").innerHTML = semesters
            .map((s) => `<option value="${s.id}">${s.title}</option>`)
            .join("");

          // Add room, rows, cols inputs to modal if not already added
          if (!document.getElementById("roomSelect")) {
            const roomSelect = document.createElement("select");
            roomSelect.name = "room_id";
            roomSelect.id = "roomSelect";
            roomSelect.required = true;
            roomSelect.innerHTML = rooms
              .map((r) => `<option value="${r.id}">${r.name}</option>`)
              .join("");
            document.getElementById("generatePlanForm").appendChild(roomSelect);

            const rowsInput = document.createElement("input");
            rowsInput.type = "number";
            rowsInput.name = "rows";
            rowsInput.placeholder = "Number of rows";
            rowsInput.required = true;
            document.getElementById("generatePlanForm").appendChild(rowsInput);

            const colsInput = document.createElement("input");
            colsInput.type = "number";
            colsInput.name = "cols";
            colsInput.placeholder = "Number of columns";
            colsInput.required = true;
            document.getElementById("generatePlanForm").appendChild(colsInput);
          }
        } catch (err) {
          console.error("Error loading dashboard data:", err);
        }
      }

      loadDashboardCounts();

      // ðŸ“ Generate Plan Form
      const generateForm = document.getElementById("generatePlanForm");
      generateForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = Object.fromEntries(
          new FormData(generateForm).entries()
        );
        try {
          const studentsRes = await fetch(
            `http://localhost:5000/api/students?department_id=${formData.department_id}&semester_id=${formData.semester_id}`
          );
          const studentsList = await studentsRes.json();
          const studentIds = studentsList.map((s) => s.id);

          // Generate seating plan
          const res = await fetch(
            "http://localhost:5000/api/seating-plans/generate",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                title: formData.title,
                plan_date: formData.plan_date,
                students: studentIds,
                room_id: formData.room_id,
                rows: parseInt(formData.rows),
                cols: parseInt(formData.cols),
              }),
            }
          );

          const data = await res.json(); // get planId and allocations
          modal.style.display = "none";
          await loadDashboardCounts();

          // âœ… Load allocated seats immediately for the new plan
          await loadAllocatedSeats(data.planId);
        } catch (err) {
          console.error("Error generating plan:", err);
        }
      });

      // ðŸª‘ Room-wise Seating Layout & PDF Export
      let allAllocatedSeats = [];

      async function loadAllocatedSeats(planId) {
        try {
          const res = await fetch(`http://localhost:5000/api/allocated-seats`);
          const data = await res.json();
          allAllocatedSeats = data.filter((a) => a.plan_id == planId);
          populateRoomFilter();
        } catch (err) {
          console.error("Error loading allocated seats:", err);
        }
      }

      function populateRoomFilter() {
        const rooms = [...new Set(allAllocatedSeats.map((a) => a.room_name))];
        const roomFilter = document.getElementById("roomFilter");
        roomFilter.innerHTML = rooms
          .map((r) => `<option value="${r}">${r}</option>`)
          .join("");
        roomFilter.onchange = () => populatePlanLayoutTable(roomFilter.value);

        // auto-select first room
        if (rooms.length) populatePlanLayoutTable(rooms[0]);

        document.getElementById("planLayoutSection").style.display = "block";
      }

      function populatePlanLayoutTable(roomName) {
        const seats = allAllocatedSeats.filter((a) => a.room_name === roomName);
        if (!seats.length) return; // handle empty room gracefully
        const maxRow = Math.max(...seats.map((s) => s.seat_row));
        const maxCol = Math.max(...seats.map((s) => s.seat_col));

        const table = document.getElementById("planLayoutTable");
        table.innerHTML = "";
        for (let r = 1; r <= maxRow; r++) {
          const tr = document.createElement("tr");
          for (let c = 1; c <= maxCol; c++) {
            const seat = seats.find(
              (s) => s.seat_row === r && s.seat_col === c
            );
            const td = document.createElement("td");
            td.textContent = seat ? seat.student_name : "-";
            td.style.border = "1px solid #ccc";
            td.style.padding = "8px";
            td.style.textAlign = "center";
            tr.appendChild(td);
          }
          table.appendChild(tr);
        }
      }

      // ðŸ“„ Export Seating Plan as PDF using jsPDF-AutoTable
      document.getElementById("exportPDF").onclick = () => {
        if (!allAllocatedSeats.length)
          return alert("No seating plan to export!");

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const roomName = document.getElementById("roomFilter").value;
        doc.setFontSize(16);
        doc.text(`Seating Plan - Room: ${roomName}`, 14, 15);

        const seats = allAllocatedSeats.filter((s) => s.room_name === roomName);
        if (!seats.length) {
          return alert("No seats found for this room!");
        }

        const maxRow = Math.max(...seats.map((s) => s.seat_row));
        const maxCol = Math.max(...seats.map((s) => s.seat_col));

        const body = [];
        for (let r = 1; r <= maxRow; r++) {
          const row = [];
          for (let c = 1; c <= maxCol; c++) {
            const seat = seats.find(
              (s) => s.seat_row === r && s.seat_col === c
            );
            row.push(seat ? seat.student_name : "-");
          }
          body.push(row);
        }

        doc.autoTable({
          head: [],
          body: body,
          startY: 25,
          theme: "grid",
          styles: { fontSize: 10, halign: "center", valign: "middle" },
        });

        doc.save(`SeatingPlan_${roomName}.pdf`);
      };
    </script>
  </body>
</html>
